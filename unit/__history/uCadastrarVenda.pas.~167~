unit uCadastrarVenda;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants,
  System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.Mask, Vcl.DBCtrls,
  Data.DB, Vcl.Grids, Vcl.DBGrids, Vcl.Buttons, Vcl.ExtCtrls;

type
  TfrmCadastrarVenda = class(TForm)
    lbl: TLabel;
    edtBuscar: TEdit;
    Label3: TLabel;
    DBEdtCPF: TDBEdit;
    Label4: TLabel;
    DBEdtTelefone: TDBEdit;
    Label5: TLabel;
    DBEdtEmail: TDBEdit;
    Label6: TLabel;
    DBEdtDataNascimento: TDBEdit;
    Label7: TLabel;
    DBEdtEndereco: TDBEdit;
    Label1: TLabel;
    btnAddItem: TSpeedButton;
    btnEditarItem: TSpeedButton;
    btnRemoverItem: TSpeedButton;
    DBGridItensDaVenda: TDBGrid;
    edtSubTotal: TEdit;
    Label2: TLabel;
    edtDesconto: TEdit;
    Label8: TLabel;
    edtFrete: TEdit;
    Label9: TLabel;
    edtValorTotal: TEdit;
    Label10: TLabel;
    Panel1: TPanel;
    btnSair: TSpeedButton;
    btnConfirmarVenda: TSpeedButton;
    btnSelecionar: TButton;
    btnCancelar: TButton;
    procedure edtBuscarChange(Sender: TObject);
    procedure btnSelecionarClick(Sender: TObject);
    procedure btnAddItemClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure btnCancelarClick(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure edtDescontoChange(Sender: TObject);
    procedure edtFreteChange(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  frmCadastrarVenda: TfrmCadastrarVenda;

implementation

{$R *.dfm}

uses uCadastrarCliente, uCadastrarProduto, uDataModule, uFunctions, uMain,
  uPedidosDeVenda, uAdicionarItemAVenda;

procedure TfrmCadastrarVenda.btnAddItemClick(Sender: TObject);
begin
  Application.CreateForm(TfrmAdicionarItemAVenda, frmAdicionarItemAVenda);
  try
    frmAdicionarItemAVenda.ShowModal;
  finally
    FreeAndNil(frmAdicionarItemAVenda);
  end;
end;

procedure TfrmCadastrarVenda.btnCancelarClick(Sender: TObject);
begin
  edtBuscar.Clear;
  btnCancelar.Enabled := false;
  btnAddItem.Enabled := false;
  btnSelecionar.Enabled := true;
  edtBuscar.Enabled := true;
  DBEdtCPF.Clear;
  DBEdtTelefone.Clear;
  DBEdtEmail.Clear;
  DBEdtDataNascimento.Clear;
  DBEdtEndereco.Clear;

  dm.CDSvendas.Close;
  dm.dataSetVendas.Close;
  dm.dataSetVendas.CommandText :=
    ('delete from venda where id = ' +
    IntToStr((getId('id', 'venda') - 1)) + ';');
  dm.dataSetVendas.Open;
  dm.CDSvendas.Open;
end;

procedure TfrmCadastrarVenda.btnSelecionarClick(Sender: TObject);
begin
  edtBuscar.Text := dm.CDSclientesnome.Text;
  btnAddItem.Enabled := true;
  btnSelecionar.Enabled := false;
  edtBuscar.Enabled := false;
  btnCancelar.Enabled := true;

  dm.CDSvendas.Append;
  dm.CDSvendasid.AsInteger := getId('id', 'venda');
  dm.CDSvendasfkCliente.AsInteger := StrToInt(dm.CDSclientesid.Text);
  dm.CDSvendas.Post;
  try
    dm.CDSvendas.ApplyUpdates(0);
  except
    on E: Exception do
      ShowMessage('Erro' + E.ToString);
  end;
end;

procedure TfrmCadastrarVenda.edtBuscarChange(Sender: TObject);
begin

  dm.CDSprodutos.Close;
  dm.dataSetProdutos.Close;
  dm.dataSetProdutos.CommandText := ('select * from produto where nome LIKE "%'
    + LowerCase(Trim(edtBuscar.Text)) + '%";');
  dm.dataSetProdutos.Open;
  dm.CDSprodutos.Open;

  dm.CDSclientes.Close;
  dm.queryClientes.Close;
  dm.queryClientes.SQL.Clear;
  dm.queryClientes.SQL.Add('select * from cliente where nome LIKE "%' +
    LowerCase(Trim(edtBuscar.Text)) + '%";');
  dm.CDSclientes.Open;

  if edtBuscar.Text <> dm.CDSclientesnome.Text then
    btnAddItem.Enabled := false;
end;

procedure TfrmCadastrarVenda.edtDescontoChange(Sender: TObject);
begin
  // edtTotal := função total;
end;

procedure TfrmCadastrarVenda.edtFreteChange(Sender: TObject);
begin
  // edtTotal := função total;
end;

procedure TfrmCadastrarVenda.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
  selectItemFromVenda;
  frmPedidosDeVenda.DBGridProdutos.DataSource := dm.DSitens;
end;

procedure TfrmCadastrarVenda.FormShow(Sender: TObject);
begin
  dm.CDSitens.Close;
  dm.dataSetItens.Close;
  dm.dataSetItens.CommandText := 'select * from item limit 0';
  dm.dataSetItens.Open;
  dm.CDSitens.Open;
  DBGridItensDaVenda.DataSource := dm.DSitens;

  DBEdtCPF.Clear;
  DBEdtTelefone.Clear;
  DBEdtEmail.Clear;
  DBEdtDataNascimento.Clear;
  DBEdtEndereco.Clear;
end;

end.
